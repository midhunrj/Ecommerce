<%- include("./layouts/user-header.ejs") %>
    <div class="mobile-header-active mobile-header-wrapper-style">
        <div class="mobile-header-wrapper-inner">
            <div class="mobile-header-top">
                <div class="mobile-header-logo">
                    <a href="index.html"><img src="assets/imgs/theme/logo.svg" alt="logo"></a>
                </div>
                <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                    <button class="close-style search-close">
                        <i class="icon-top"></i>
                        <i class="icon-bottom"></i>
                    </button>
                </div>
            </div>
            <div class="mobile-header-content-area">
                <div class="mobile-search search-style-3 mobile-header-border">
                    <form action="#">
                        <input type="text" placeholder="Search for items…">
                        <button type="submit"><i class="fi-rs-search"></i></button>
                    </form>
                </div>
                <div class="mobile-menu-wrap mobile-header-border">
                    <div class="main-categori-wrap mobile-header-border">
                        <a class="categori-button-active-2" href="#">
                            <span class="fi-rs-apps"></span> Browse Categories
                        </a>
                        <div class="categori-dropdown-wrap categori-dropdown-active-small">
                            <ul>
                                <li><a href="shop-grid-right.html"><i class="evara-font-dress"></i>Women's Clothing</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-tshirt"></i>Men's Clothing</a></li>
                                <li> <a href="shop-grid-right.html"><i class="evara-font-smartphone"></i> Cellphones</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-desktop"></i>Computer & Office</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-cpu"></i>Consumer Electronics</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-home"></i>Home & Garden</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-high-heels"></i>Shoes</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-teddy-bear"></i>Mother & Kids</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-kite"></i>Outdoor fun</a></li>
                            </ul>
                        </div>
                    </div>
                    <!-- mobile menu start -->
                    <nav>
                        <ul class="mobile-menu">
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="/home">Home</a>
                               
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="/shop">shop</a>
                                
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Mega menu</a>
                                <ul class="dropdown">
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Women's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Dresses</a></li>
                                            <li><a href="shop-product-right.html">Blouses & Shirts</a></li>
                                            <li><a href="shop-product-right.html">Hoodies & Sweatshirts</a></li>
                                            <li><a href="shop-product-right.html">Women's Sets</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Men's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Jackets</a></li>
                                            <li><a href="shop-product-right.html">Casual Faux Leather</a></li>
                                            <li><a href="shop-product-right.html">Genuine Leather</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Technology</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Gaming Laptops</a></li>
                                            <li><a href="shop-product-right.html">Ultraslim Laptops</a></li>
                                            <li><a href="shop-product-right.html">Tablets</a></li>
                                            <li><a href="shop-product-right.html">Laptop Accessories</a></li>
                                            <li><a href="shop-product-right.html">Tablet Accessories</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Pages</a>
                                <ul class="dropdown">
                                    <li><a href="page-about.html">About Us</a></li>
                                    <li><a href="page-contact.html">Contact</a></li>
                                    <li><a href="page-account.html">My Account</a></li>
                                    <li><a href="page-login-register.html">login/register</a></li>
                                    <li><a href="page-purchase-guide.html">Purchase Guide</a></li>
                                    <li><a href="page-privacy-policy.html">Privacy Policy</a></li>
                                    <li><a href="page-terms.html">Terms of Service</a></li>
                                    <li><a href="page-404.html">404 Page</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Language</a>
                                <ul class="dropdown">
                                    <li><a href="#">English</a></li>
                                    <li><a href="#">French</a></li>
                                    <li><a href="#">German</a></li>
                                    <li><a href="#">Spanish</a></li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                    <!-- mobile menu end -->
                </div>
                <div class="mobile-header-info-wrap mobile-header-border">
                    <div class="single-mobile-header-info mt-30">
                        <a  href="page-contact.html"> Our location </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <li class="dropdown nav-item">
                            <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img class="img-xs rounded-circle" src="assets/imgs/people/avatar2.jpg" alt="User"></a>
                            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                                <a class="dropdown-item" href="/profile"><i class="material-icons md-perm_identity"></i> Profile</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account Settings</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-account_balance_wallet"></i>Wallet</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
                                <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help center</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="/logout"><i class="material-icons md-exit_to_app"></i>Logout</a>
                            </div>
                        </li>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="#">(+01) - 2345 - 6789 </a>
                    </div>
                </div>
                <div class="mobile-social-icon">
                    <h5 class="mb-15 text-grey-4">Follow Us</h5>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-youtube.svg" alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Your Cart
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="table-responsive">
                            <% if(Cart){ %>
                                 <% let totalSubtotal=0 %>
                                <table class="table shopping-summery text-center clean">
                                    <thead>
                                        <tr class="main-heading">
                                            <th scope="col">Image</th>
                                            <th scope="col">Name</th>
                                            <th scope="col">Price</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Subtotal</th>
                                            <th scope="col">Remove</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% for(let i=0; i<Cart.cartItems.length; i++){ %>
                                            <% if(products[i]&&products[i]._id){ %>
                                                <% var x=0 %>
                                               
                                                <% console.log("Cartpage") %>
                                            <tr>
                                                <td class="image product-thumbnail"><img src="./productImage/<%= products[i].image[0] %>" alt="#"></td>
                                                <td class="product-des product-name">
                                                    <h5 class="product-name"><a href="shop-product-right.html"><%= products[i].productname %></a></h5>
                                                    <!-- Adjust the path to the actual property in your product data -->
                                                    <p class="font-xs"><%= products[i].Brand %></p>
                                                </td>
                                                <td class="price" data-title="Price"><span> ₹<%= Cart.cartItems[i].price %> </span></td>
                                                <td class="text-center" data-title="Stock">
                                                    <div class="detail-qty border radius m-auto">
                                                        <% if (typeof i !== 'undefined') { %>
                                                            
                                               <button class="btn btn-sm decrement-button" data-product-index="<%= i %>" onclick="updateQuantity('<%= cartdata[i].product_id %>','<%= cartdata[i].quantity %>','-1','<%= cartdata[i].price %>','<%= i %>','<%= products[i].stock %>')">-</button>
                                               <input class="qty-val" id="cartProductQuantity<%= i %>" value="<%= cartdata[i].quantity %>" style="width: 45px;" type="text" readonly value="">
                                              <button class="btn btn-sm increment-button" data-product-index="<%= i %>" onclick="updateQuantity('<%= cartdata[i].product_id %>','<%= cartdata[i].quantity %>','1','<%= cartdata[i].price %>','<%= i %>','<%= products[i].stock %>')">+</button>

                                                       <% console.log("value of i",i); %>     
                                                        <% } %>
                                                    </div>
                                                </td>
                                                
                                                <td class="text-right" data-title="Cart">
            <% let subtotal = cartdata[i].price * cartdata[i].quantity; %>
            <% totalSubtotal += subtotal; %>
            <span><text id="subTotal<%= i %>"> ₹<%= subtotal %>.00</text></span>
        </td>
        <td class="action" data-title="Remove">
            <a href="/delete-cart?id=<%=Cart.cartItems[i].product_id %>" class="text-muted" onclick="return handleDelete(event)"><i class="fi-rs-trash"></i></a>
        </td>
        
                                            </tr>
                                            <% console.log(cartdata[i].price * cartdata[i].quantity,"qqqq"); %>

                                            <%  x +=cartdata[i].price * cartdata[i].quantity%>
                                        <% } %>
                                        <% }  %>
                                       
                         
                                  <% console.log(x,"xxx"); %>

                                                        <input type="hidden" name="" id="totalabc" value="<%= x  %>">
                                                    </tbody>
                                                </table>
                </div>

                
                        
                                     
                                </tbody>
                            </table>
                            
                        </div>
                        <div class="cart-action text-end">
                            <!-- <a class="btn  mr-10 mb-sm-15"><i class="fi-rs-shuffle mr-10"></i>Update Cart</a> -->
                            <a class="btn " href="/shop"><i class="fi-rs-shopping-bag mr-10"></i>Continue Shopping</a>
                        </div>
                        
                            <div class="col-lg-6 col-md-12">
                                <div class="border p-md-4 p-30 border-radius cart-totals">
                                    <div class="heading_s1 mb-3">
                                        <h4>Cart Totals</h4>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <tbody>
                                                <tr>
                                                    <td class="cart_total_label">Cart Subtotal</td>
                                                    <td class="cart_total_amount"><span class="font-lg fw-900 text-brand" >₹<text id="totalPrice"><%= totalSubtotal %></text></span></td>
                                                </tr>
                                                <tr>
                                                    <td class="cart_total_label">Shipping</td>
                                                    <td class="cart_total_amount"> <i class="ti-gift mr-5"></i> Free Shipping</td>
                                                </tr>
                                                <tr>
                                                    <td class="cart_total_label">Total</td>
                                                    <td class="cart_total_amount"><strong><span class="font-xl fw-900 text-brand" >₹<text id="total"><%= totalSubtotal %></text></span></strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <a href="/checkout" class="btn "> <i class="fi-rs-box-alt mr-10"></i> Proceed To CheckOut</a>
                                </div>
                            </div>
                            
                            <% } else { %>
                                
                                <!-- Handle case when the cart is empty -->
                                <p>Your cart is empty.</p>
                                <div class="container mt-5">
                                    <div class=" text-center">
                                        <img src="/assets/imgs/page/empty-cart.png" alt="Empty Cart Image">
                                        <p>Uh-oh! Your cart is feeling a bit lonely.</p>
                                        <p>Time to fill it up with amazing finds!</p>
                                        <a href="/shop" class="btn btn-primary">Add something to Cart</a>
                                    </div>
                                </div>
                                <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <%- include("./layouts/footer.ejs") %>
    <!-- Vendor JS-->
    <script>
   let totalSubtotal=0
        function updateQuantity(productId, cartQuantity, count, productPrice, i, productQuantity) {
           

            const abc = document.getElementById("totalabc").value
            console.log(abc, "hi");
            console.log(productId, cartQuantity, count, productPrice, i, productQuantity);
            const cartProductQuantityElement = document.querySelector(`#cartProductQuantity${i}`)
            
            console.log(cartProductQuantityElement);
          console.log(cartProductQuantityElement.value);
             
            let subtotalElement = document.querySelector(`#subTotal${i}`);
            console.log(subtotalElement,"subbbbbbb");
             
             console.log(productPrice);
             
          

            let currentQuantity = parseInt(cartProductQuantityElement.value)
            console.log("currentQuantity",currentQuantity);
            
            let currentSubTotal = parseFloat(subtotalElement.innerText);

            console.log("currentSubtotal",currentSubTotal);
        
             console.log("hello");
            
            if(isNaN(currentQuantity))
            {
               
            }
            else{
                
            }
            const countAsNumber = parseInt(count, 10);

      if (isNaN(countAsNumber)) {
   
    } else {
    
    }

const newQuantity = currentQuantity + countAsNumber;

console.log("cipher",newQuantity);
    //             if (newQuantity==0 ) {
    //                 console.log("jongiliyan");
    //     // Initiate request to delete the item from the cart
    //     $.ajax({
    //         url: '/delete-cart?id=' + productId, // Pass productId to identify the item to be deleted
    //         method: 'GET',
    //         success: (response) => {
    //             console.log(response);
    //             // Handle any UI updates or reload the page after successful removal
                
    //             window.location.href='/cart'
                 
    //         },
    //         error: (error) => {
    //             console.error(error);
               
    //         }
    //     });
    //     return; // Return from the function after initiating removal process
    // }

    if (newQuantity <= 0) {
        Swal.fire({
            title: "Are you sure?",
            text: "Removing this will delete it from your cart!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, remove it!",
            cancelButtonText: "No, keep it"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/delete-cart?id=' + productId,
                    method: 'GET',
                    success: (response) => {
                        Swal.fire("Deleted!", "The item has been removed from your cart.", "success")
                            .then(() => window.location.href = '/cart');
                    },
                    error: (error) => {
                        console.error(error);
                        Swal.fire("Error!", "Something went wrong. Try again.", "error");
                    }
                });
            } else {
                cartProductQuantityElement.value = 1; // Reset quantity to 1 if the user cancels
            }
        });
        return;
    }

            

            if(currentSubTotal < currentSubTotal){
                return
            }

            if (count == 1 && newQuantity > productQuantity) {


                Swal.fire({
                    title: 'STOCK!',
                    text: 'Product is out of stock.',
                    icon: 'error',
                    timer: 5000
                })
                return
            }



 // Update subtotal dynamically
 const newSubtotal = newQuantity * productPrice;
        if (count == 1) {
        
            document.getElementById(`subTotal${i}`).innerText = ` ₹${newSubtotal.toFixed(2)}`;
        } else {
           
            document.getElementById(`subTotal${i}`).innerText = ` ₹${newSubtotal.toFixed(2)}`;
        }
        console.log("newSubtotal",newSubtotal);

        // Recalculate totalSubtotal
        totalSubtotal += newSubtotal;
        const totalElements = document.getElementById('total').innerHTML;
        console.log("totalsubtotal",totalSubtotal);
             
            $.ajax({
    url: '/updateQuantity',
    method: 'POST',
    data: {
        productId: productId,
        count: count
    },
    success: (response) => {
        console.log(response,"reSSSS");
       

        currentQuantity = parseInt(cartProductQuantityElement.value);
        
        console.log(currentQuantity, 'currQua');
        currentSubTotal =(subtotalElement.innerText);
        
        console.log(currentSubTotal, 'subttl');
        
        document.getElementById(`cartProductQuantity${i}`).value = currentQuantity + parseInt(count);

       
        const newSubtotal = newQuantity * productPrice;
        if (count == 1) {
           
            document.getElementById(`subTotal${i}`).innerText = ` ₹${newSubtotal.toFixed(2)}`;
        } else {
            
            document.getElementById(`subTotal${i}`).innerText = ` ₹${newSubtotal.toFixed(2)}`;
        }
        console.log("newSubtotal",newSubtotal);

        // Recalculate totalSubtotal
        totalSubtotal += newSubtotal;

        // Update totalSubtotal on the page
         document.getElementById('total').innerHTML=response.tot;
         document.getElementById('totalPrice').innerHTML=response.tot;
        
    },
    error: (error) => {
        // alert(error)
    }
});
        }
</script>
<script>
function handleDelete(event) {
    // Prevent the default behavior of the anchor tag
    event.preventDefault();
    
    // Get the href attribute which contains the URL to delete the item from the cart
    const url = event.currentTarget.getAttribute('href'); // Use currentTarget instead of target
    console.log("url", url);
    
    // // Initiate request to delete the item from the cart
    // $.ajax({
    //     url: url,
    //     method: 'GET',
    //     success: (response) => {
    //         console.log(response);
    //         // Reload the page after successful removal
    //         location.reload();
    //     },
    //     error: (error) => {
    //         console.error(error);
    //         // Handle error case if needed
    //     }
    // });

    Swal.fire({
        title: "Are you sure?",
        text: "Do you want to remove this item from your cart?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, remove it!",
        cancelButtonText: "No, keep it"
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: url,
                method: 'GET',
                success: (response) => {
                    Swal.fire("Deleted!", "The item has been removed from your cart.", "success")
                        .then(() => location.reload()); // Reload after deletion
                },
                error: (error) => {
                    console.error(error);
                    Swal.fire("Error!", "Something went wrong. Try again.", "error");
                }
            });
        }
    });
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>

    <script src="assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="assets/js/plugins/slick.js"></script>
    <script src="assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="assets/js/plugins/wow.js"></script>
    <script src="assets/js/plugins/jquery-ui.js"></script>
    <script src="assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="assets/js/plugins/magnific-popup.js"></script>
    <script src="assets/js/plugins/select2.min.js"></script>
    <script src="assets/js/plugins/waypoints.js"></script>
    <script src="assets/js/plugins/counterup.js"></script>
    <script src="assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="assets/js/plugins/images-loaded.js"></script>
    <script src="assets/js/plugins/isotope.js"></script>
    <script src="assets/js/plugins/scrollup.js"></script>
    <script src="assets/js/plugins/jquery.vticker-min.js"></script>
    <!-- Template  JS -->
    <script src="./assets/js/main.js?v=3.4"></script>
    <script src="./assets/js/shop.js?v=3.4"></script>
</body>

</html>