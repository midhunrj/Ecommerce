<%- include("./layouts/user-header.ejs") %>
    <div class="mobile-header-active mobile-header-wrapper-style">
        <div class="mobile-header-wrapper-inner">
            <div class="mobile-header-top">
                <div class="mobile-header-logo">
                    <a href="index.html"><img src="/assets/imgs/theme/logo.png" alt="logo"></a>
                </div>
                <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                    <button class="close-style search-close">
                        <i class="icon-top"></i>
                        <i class="icon-bottom"></i>
                    </button>
                </div>
            </div>
            <div class="mobile-header-content-area">
                <div class="mobile-search search-style-3 mobile-header-border">
                    <form action="/shop" method="get" style="position: relative; display: flex; gap: 10px;">
                        <input
                          type="text"
                          id="searchInput"
                          name="search"
                          value="<%= typeof search !== 'undefined' ? search : '' %>"
                          placeholder="Search for items…"
                          style="padding-right: 30px;"
                        />
                        <input type="hidden" name="sort" value="<%= typeof sort !== 'undefined' ? sort : '' %>" />
                        <input type="hidden" name="priceRange" value="<%= typeof priceRange !== 'undefined' ? priceRange : '' %>" />
                      
                        <!-- Submit Button -->
                        <button type="submit"><i class="fi-rs-search"></i></button>
                      
                        <!-- Clear Button -->
                        <% if (search && search.trim() !== '') { %>
                          <button
                            type="button"
                            onclick="clearSearch()"
                            style="position: absolute; right: 70px; top: 50%; transform: translateY(-50%); border: none; background: transparent; font-size: 16px; cursor: pointer;"
                          >
                            ×
                          </button>
                        <% } %>
                      </form>
                        
                </div>
                <div class="mobile-menu-wrap mobile-header-border">
                    <div class="main-categori-wrap mobile-header-border">
                        <a class="categori-button-active-2" href="#">
                            <span class="fi-rs-apps"></span> Browse Categories
                        </a>
                        <div class="categori-dropdown-wrap categori-dropdown-active-small">
                            <ul>
                                <li><a href="shop-grid-right.html"><i class="evara-font-dress"></i>Women's Clothing</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-tshirt"></i>Men's Clothing</a></li>
                                <li> <a href="shop-grid-right.html"><i class="evara-font-smartphone"></i> Cellphones</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-desktop"></i>Computer & Office</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-cpu"></i>Consumer Electronics</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-home"></i>Home & Garden</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-high-heels"></i>Shoes</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-teddy-bear"></i>Mother & Kids</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-kite"></i>Outdoor fun</a></li>
                            </ul>
                        </div>
                    </div>
                  
                    <nav>
                        <ul class="mobile-menu">
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="/home" id="home">Home</a>
                               
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="/shop" id="shop">shop</a>
                                
                            </li>
                            
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Language</a>
                                <ul class="dropdown">
                                    <li><a href="#">English</a></li>
                                    <li><a href="#">French</a></li>
                                    <li><a href="#">German</a></li>
                                    <li><a href="#">Spanish</a></li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                    <!-- mobile menu end -->
                </div>
                <div class="mobile-header-info-wrap mobile-header-border">
                    <div class="single-mobile-header-info mt-30">
                        <a  href="page-contact.html"> Our location </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="page-login-register.html">Log In / Sign Up </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="#">(+01) - 2345 - 6789 </a>
                    </div>
                </div>
                <div class="mobile-social-icon">
                    <h5 class="mb-15 text-grey-4">Follow Us</h5>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-youtube.svg" alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/home" id="home" rel="nofollow">Home</a>
                    <span></span><a href="/shop" id="shop"> Shop</a>
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 primary-sidebar sticky-sidebar">
                        <div class="widget-category mb-30">
                            <h5 class="section-title style-1 mb-30 wow fadeIn animated">Category</h5>
                            <% if(category && category.length > 0) { %>
                                <ul class="categories">
                                    <li>
                                        <a href="/shop">All category</a>
                                    </li>
                                    <% for (let i = 0; i < category.length; i++) { %>
                                        <li>
                                            <a href="#" onclick="handleCategoryClick('<%= category[i]._id %>')">
                                                <%= category[i].catName %>
                                            </a>
                                        </li>
                                    <% } %>
                                </ul>
                            <% } %>
                        </div>
    
                        <div class="sidebar-widget price_range range mb-30">
                            <div class="widget-header position-relative mb-20 pb-10">
                                <h5 class="widget-title mb-10">Filter by price</h5>
                                <div class="bt-1 border-color-1"></div>
                            </div>
                            <form action="/shop" method="get">
                                <input type="hidden" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>">
                                <input type="hidden" name="sort" value="<%= typeof sort !== 'undefined' ? sort : '' %>">
                                <input type="hidden" name="category" value="<%= typeof categoryId !== 'undefined' ? categoryId : '' %>" />

                                <select name="priceRange" class="form-control">
                                  <option value="0-999" <%= priceRange === '0-999' ? 'selected' : '' %>>0-999</option>
                                  <option value="1000-4999" <%= priceRange === '1000-4999' ? 'selected' : '' %>>1000-4999</option>
                                  <option value="5000-14999" <%= priceRange === '5000-14999' ? 'selected' : '' %>>5000-14999</option>
                                  <option value="15000-49999" <%= priceRange === '15000-49999' ? 'selected' : '' %>>15000-49999</option>
                                  <option value="greater than 50000" <%= priceRange === 'greater than 50000' ? 'selected' : '' %>>greater than 50000</option>
                                </select>
                              
                                <br><br>
                                <button type="submit">Filter</button>
                              </form>
                              
                        </div>
    
                        <div class="sidebar-widget product-sidebar mb-30 p-30 bg-grey border-radius-10">
                            <div class="widget-header position-relative mb-20 pb-10">
                                <h5 class="widget-title mb-10">New products</h5>
                                <div class="bt-1 border-color-1"></div>
                            </div>
                            <div class="single-post clearfix">
                                <div class="image">
                                    <img src="assets/imgs/shop/thumbnail-3.jpg" alt="#">
                                </div>
                                <div class="content pt-10">
                                    <h5><a href="shop-product-detail.html">Chen Cardigan</a></h5>
                                    <p class="price mb-0 mt-5">$99.50</p>
                                    <div class="product-rate">
                                        <div class="product-rating" style="width:90%"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- ... (repeat for other products) ... -->
                        </div>
    
                        <div class="banner-img wow fadeIn mb-45 animated d-lg-block d-none">
                            <img src="/product-images/minh-pham-RsmOYMxmlYU-unsplash.jpg" alt="">
                            <div class="banner-text">
                                <span>Electronics</span>
                                <h4>Save 10% on <br>Headsets</h4>
                                <a href="/shop">Shop Now <i class="fi-rs-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>
    
                    <div class="col-lg-9">
                        <div class="shop-product-fillter style-2">
                            <div class="totall-product">
                                <p> We found <strong class="text-brand"><%= products.length %></strong> items for you!</p>
                            </div>
                            <div class="sort-by-product-area">
                                
                                <div class="sort-by-cover">
                                    <div class="sort-by-product-wrap">
                                        <div class="sort-by">
                                            <span><i class="fi-rs-apps-sort"></i>Sort by:</span>
                                        </div>
                                        <div class="sort-by-dropdown-wrap">
                                            <span id="selectedSortOption">Featured <i class="fi-rs-angle-small-down"></i></span>
                                        </div>
                                    </div>
                                    <div class="sort-by-dropdown">
                                        <ul id="sortOptions">
                                            <li><a class="<%= sort === 'featured' ? 'active' : '' %>" href="/shop?sort=featured&search=<%= search || '' %>&priceRange=<%= priceRange || '' %>&category=<%= categoryId || '' %>"">Featured</a></li>
                                            <li><a href="/shop?sort=lowtohigh&search=<%= search || '' %>&priceRange=<%= priceRange || '' %>&category=<%= categoryId || '' %>"">Price: Low to High</a></li>
                                            <li><a href="/shop?sort=hightolow&search=<%= search || '' %>&priceRange=<%= priceRange || '' %>&category=<%= categoryId || '' %>"">Price: High to Low</a></li>
                                            <li><a href="/shop?sort=atoz&search=<%= search || '' %>&priceRange=<%= priceRange || '' %>&category=<%= categoryId || '' %>"">Alphabetical: A to Z</a></li>
                                            <li><a href="/shop?sort=ztoa&search=<%= search || '' %>&priceRange=<%= priceRange || '' %>&category=<%= categoryId || '' %>"">Alphabetical: Z to A</a></li>
                                          </ul>
                                          
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% if (products && products.length > 0) { %>
                            <% for (let i = 0; i < products.length; i++) { %>
                             <div class="product-list mb-50" style="display: flex; align-items: center;">

   <div class="product-cart-wrap" style="display: flex; width: 100%;">
                                  <div class="product-img-action-wrap" style="width: 30%;">
                                    <div class="product-img product-img-zoom">
                                      <div class="product-img-inner">
                                        <a href="/productDetails?id=<%= products[i]._id %>" id="productdetails">
                                          <img class="default-img" src="./productImage/<%= products[i].image[0] %>"
                                               style="height:200px;" alt="product">
                                        </a>
                                      </div>
                                    </div>
                                    <div class="product-action-1">
                                      <a aria-label="Quick view" class="action-btn hover-up" data-bs-toggle="modal"
                                         data-bs-target="#quickViewModal"><i class="fi-rs-search"></i></a>
                                      <a aria-label="Add To Wishlist" class="action-btn hover-up"  onclick="addToWishlist('<%= products[i]._id %>')">
                                        <i class="fi-rs-heart"></i></a>
                                      <a aria-label="Compare" class="action-btn hover-up" href="#"><i
                                          class="fi-rs-shuffle"></i></a>
                                    </div>
                                    <div class="product-badges product-badges-position product-badges-mrg">
                                      <span class="hot">Hot</span>
                                    </div>
                                  </div>
                                  <div class="product-content-wrap" style="width: 70%; padding-left: 20px;">
                                    <div class="product-category">
                                      <a href="shop-grid-right.html"><%= products[i].Brand %></a>
                                    </div>
                                    <h2><a href="shop-product-right.html"><%= products[i].productname %></a></h2>
                                    <div class="product-price">
                                        <% if(category&&category.length>0){ %>
                                            <% for(let j=0; j<category.length; j++){ %>
                                                <% console.log(category[j]._id); %>
                                                <% if(products[i].Category.toString() === category[j]._id.toString()){ %>
                                                    <% console.log("before offer discounted", category[j].offer); %>
                                                <% let productprice=products[i].price %>
                                                <% let productoffer=products[i].offer %>
                                                <% let categoryoffer=category[j].offer %>
                                                <% if(category[j].offer > 0|| products[i].offer>0){ %>
                                                    <% let originalPrice = Math.floor(productprice / (1 - categoryoffer+productoffer / 100)); %>

                                                    <% console.log("original price", originalPrice); %>
                                                    <div class="price mb-2">
                                                        <span>&#8377;<%= products[i].price %></span>
                                                        <span class="old-price">&#8377;<%= products[i].originalprice %></span>
                                                        <span class="text-danger"><%= categoryoffer+productoffer %>% off</span>
                                                    </div>
                                                    <% } else { %>
                                                        <div class="price mb-2">
                                                            &#8377;<%= products[i].price %>
                                                        </div>
                                                    <% } %>
                                                <% } %>
                                            <% }} %>
                                    </div>
                                    <p class="mt-15"><%= products[i].description %></p>
                                    <div class="product-action-1 show">
                                      <a aria-label="Buy now" class="action-btn" href="javascript:void(0);" onclick="addToCart('<%= products[i]._id %>')">
                                        <i class="fi-rs-shopping-bag-add"></i> Add to Cart
                                      </a>
                                      <div class="rating-result" title="90%">
                                        <span>
                                          <span>90%</span>
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            <% } %>
                          <% } %>
                  
                          <!--pagination-->
                          <div class="pagination-area mt-20 mb-20">
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    <% if (currentPage > 1) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="/shop?page=<%= currentPage - 1 %>&search=<%= search || '' %>&sort=<%= sort || '' %>&priceRange=<%= priceRange || '' %>">&laquo; Prev</a>
                                        </li>
                                    <% } %>
                        
                                    <% for (let i = 1; i <= totalNumberOfPages; i++) { %>
                                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                            <a class="page-link" href="/shop?page=<%= i %>&search=<%= search || '' %>&sort=<%= sort || '' %>&priceRange=<%= priceRange || '' %>"><%= i %></a>
                                        </li>
                                    <% } %>
                        
                                    <% if (currentPage < totalNumberOfPages) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="/shop?page=<%= currentPage + 1 %>&search=<%= search || '' %>&sort=<%= sort || '' %>&priceRange=<%= priceRange || '' %>">Next &raquo;</a>
                                        </li>
                                    <% } %>
                                </ul>
                            </nav>
                        </div>
                        
                  
                        </div>
                      </div>
                    </div>
                  </section>
    
        
    </main>
    <%- include("./layouts/footer.ejs") %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<!-- 
<script>
    function handleCategoryClick(categoryId) {
      const url = new URL(window.location.origin + "/shop");
      url.searchParams.set("category", categoryId);
      url.searchParams.set("page", 1); // reset to first page
      window.location.href = url.href;
    }
  </script> -->
  
<script>
    function addToCart(productId) {
        console.log("Product ID:", productId);
   
        $.ajax({
            url: '/Add-cart',
            method: 'POST',
            data: { productId: productId },  // Pass productId in the request payload
        success: (response) => {
            console.log(response);
            if (response.success) {
                
                Swal.fire({
                    title: 'Product Added!',
                    text: 'Product has been added to your cart.',
                    icon: 'success',
                    timer: 3000                      
                });
               
             var carticon=document.getElementById('cart-count')
            var cartcount=parseInt(carticon.innerText)
            console.log(cartcount,"cartcount before")
             carticon.innerText=cartcount+1
             //alert(carticon.innerText)
            console.log(carticon.innerText);
            
               } else {
                        Swal.fire({
                            title: 'Error!',
                            text: response.message ||'Failed to add product to cart.',
                            icon: 'error',
                            timer: 3000
                        });
                    }
                },
                error: function (xhr) {
            if (xhr.status === 401) { // Not authorized
                Swal.fire({
                    title: 'Login Required!',
                    text: 'You must login to add products to your cart.',
                    icon: 'warning',
                    timer: 2000
                }).then(() => {
                    window.location.href = '/login';
                });
            } else {
                
Swal.fire({
    title: 'Error!',
    text: 'Failed to add product to cart.',
    icon: 'error',
    timer: 3000
});
            }
        }
            });
    }
    
</script>
<script>
    function handleCategoryClick(categoryId) {
        const url = new URL(window.location.href);
        const search = url.searchParams.get("search") || "";
        const sort = url.searchParams.get("sort") || "";
        const priceRange = url.searchParams.get("priceRange") || "";

        const newUrl = `/shop?id=${categoryId}&search=${encodeURIComponent(search)}&sort=${encodeURIComponent(sort)}&priceRange=${encodeURIComponent(priceRange)}`;
        window.location.href = newUrl;
    }
</script>

<script>
    function applyFilters() {
      // Gather selected filters
      const selectedCategories = $('input[name="Category"]:checked').map(function () {
        return this.value;
      }).get();
  
      const selectedColors = $('input[name="colors"]:checked').map(function () {
        return this.value;
      }).get();
  
      // Add more lines to gather other filters (brands, price range, etc.)
  
      // Make an AJAX request
      $.ajax({
        type: 'GET',
        url: '/apply-filters',
        data: {
          categories: selectedCategories.join(','),
          colors: selectedColors.join(',')
          // Add more lines to include other filters in the request
        },
        success: function (data) {
          // Update the product list with the filtered results
          $('#product-list-container').html(data);
        },
        error: function (error) {
          console.error('Error applying filters:', error);
        }
      });
    }
  
    // Attach the applyFilters function to the filter button click event
    $('#filter-button').on('click', function () {
      applyFilters();
    });
  </script>
<script>
    function addToWishlist(productId)
    {
        $.ajax({
            url:'/addtowishlist',
            method:"POST",
            data:{productId},
            success:(response)=>{
                console.log(response);
                if (response.green)
                {
                Swal.fire({
            title:'Added to Wishlist',
            text:'product has been  added to wishlist',
            icon: 'success',
            timer: 3000 
             }) 
             var wishicon=document.getElementById('wishlist-count')
            var wishcount=parseInt(wishicon.innerText)
             wishicon.innerText=wishcount+1
            }
            else if(response.red)
            {
                Swal.fire({
                        title: 'Error!',
                        text: response.message ||'product is already added to wishlist',
                        icon: 'error',
                        timer: 3000
                    });
            }
            },
            error: function (xhr) {
            if (xhr.status === 401) { // Not authorized
                Swal.fire({
                    title: 'Login Required!',
                    text: 'You must login to add products to your wishlist.',
                    icon: 'warning',
                    timer: 2000
                }).then(() => {
                    window.location.href = '/login';
                });
            } else {
                
                Swal.fire({
                    title: 'Error!',
                    text: 'Failed to add product to wishlist.',
                    icon: 'error',
                    timer: 3000
                });
            }
        }
        })
    }
</script>
<script>
    function sortProducts() {
        var selectBox = document.getElementById("priceSortDropdown");
        var selectedValue = selectBox.options[selectBox.selectedIndex].value;

        var productList = document.querySelectorAll(".product-list");

        var sortedProducts = Array.from(productList).sort((a, b) => {
            var priceA = parseFloat(a.querySelector(".product-price span:first-child").innerText.substr(1));
            var priceB = parseFloat(b.querySelector(".product-price span:first-child").innerText.substr(1));

            if (selectedValue === "lowToHigh") {
                return priceA - priceB;
            } else {
                return priceB - priceA;
            }
        });

        var parent = productList[0].parentNode;
        productList.forEach(element => parent.removeChild(element));
        sortedProducts.forEach(element => parent.appendChild(element));
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const sortOptions = document.getElementById("sortOptions");
        const selectedSortOption = localStorage.getItem("selectedSortOption");
        
        // Check if there's a selected option stored in local storage
        if (selectedSortOption) {
            // Move the selected option to the top
            const selectedOption = document.querySelector(`#sortOptions li a[href="/shop?sort=${selectedSortOption}"]`).closest("li");
            sortOptions.insertBefore(selectedOption, sortOptions.firstChild);
            // Update the displayed selected option
            document.getElementById("selectedSortOption").textContent = selectedOption.textContent;
        }

        sortOptions.addEventListener("click", function(event) {
            const selectedOption = event.target.closest("li");
            if (selectedOption) {
                // Move the selected option to the top
                sortOptions.insertBefore(selectedOption, sortOptions.firstChild);
                // Update the displayed selected option
                const selectedText = selectedOption.textContent;
                document.getElementById("selectedSortOption").textContent = selectedText;
                // Store the selected option in local storage
                const selectedSortOptionValue = selectedOption.querySelector("a").getAttribute("href").split("=")[1];
                localStorage.setItem("selectedSortOption", selectedSortOptionValue);
            }
        });
    });
</script>
<script>
    const searchInput = document.querySelector('input[name="search"]');
    searchInput?.addEventListener('input', () => {
      if (searchInput.value.trim() === '') {
        window.location.href = '/shop';
      }
    });
  </script>
  <script>
    function clearSearch() {
      const input = document.getElementById('searchInput');
      input.value = '';
      window.location.href = '/shop'; // redirect to remove all query params
    }
  </script>
  

     <!-- <script src="assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="assets/js/plugins/slick.js"></script>
    <script src="assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="assets/js/plugins/wow.js"></script>
    <script src="assets/js/plugins/jquery-ui.js"></script>
    <script src="assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="assets/js/plugins/magnific-popup.js"></script>
    <script src="assets/js/plugins/select2.min.js"></script>
    <script src="assets/js/plugins/waypoints.js"></script>
    <script src="assets/js/plugins/counterup.js"></script>
    <script src="assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="assets/js/plugins/images-loaded.js"></script>
    <script src="assets/js/plugins/isotope.js"></script>
    <script src="assets/js/plugins/scrollup.js"></script>
    <script src="assets/js/plugins/jquery.vticker-min.js"></script>
    <script src="assets/js/plugins/jquery.theia.sticky.js"></script>
    <script src="assets/js/plugins/jquery.elevatezoom.js"></script>
    Template  JS 
    <script src="./assets/js/main.js?v=3.4"></script>
    <script src="./assets/js/shop.js?v=3.4"></script> -->
</body>

</html>
